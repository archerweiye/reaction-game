<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âš¡ ååº”åŠ›å¤§æŒ‘æˆ˜</title>
    <style>
        * { margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: sans-serif; 
            overflow: hidden;
            background: #1a1a2e;
            color: #fff;
            touch-action: manipulation;
        }
        #game {
            width: 100vw; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        .waiting { background: #e74c3c !important; transition: background 0.3s; }
        .go { background: #27ae60 !important; transition: background 0.1s; }
        .result { background: #8e44ad !important; }
        .too-early { background: #c0392b !important; }
        
        h1 { font-size: 2rem; margin-bottom: 10px; }
        p { font-size: 1.2rem; margin: 10px 0; }
        .time { font-size: 5rem; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        
        .rank-box {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            width: 100%;
            max-width: 280px;
            max-height: 35vh;
            overflow-y: auto;
            text-align: left;
        }
        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .rank-item:last-child { border-bottom: none; }
        .rank-item.first { color: #ffd700; }
        .rank-item.second { color: #c0c0c0; }
        .rank-item.third { color: #cd7f32; }
        
        button {
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 12px;
            border: none;
            background: #fff;
            color: #333;
            cursor: pointer;
            margin: 8px;
            font-weight: bold;
            min-width: 160px;
            -webkit-tap-highlight-color: rgba(255,255,255,0.3);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        button:active { transform: scale(0.95); }
        button.secondary { 
            background: transparent; 
            color: #fff; 
            border: 2px solid rgba(255,255,255,0.6); 
        }
        button.small { 
            padding: 8px 16px; 
            font-size: 0.9rem; 
            min-width: auto;
        }
        
        .name-display { font-size: 0.9rem; opacity: 0.8; margin-bottom: 15px; }
        .stats { font-size: 0.85rem; opacity: 0.7; margin-top: 10px; }
        .best-badge { 
            background: linear-gradient(135deg, #ffd700, #ffaa00); 
            color: #333; 
            padding: 3px 10px; 
            border-radius: 20px; 
            font-size: 0.8rem;
            margin-left: 8px;
        }
        .rating { 
            font-size: 1.5rem; 
            margin: 10px 0; 
            animation: bounce 0.5s;
        }
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.3s; }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .popup {
            background: #fff;
            color: #333;
            padding: 25px;
            border-radius: 16px;
            max-width: 90%;
            width: 320px;
            text-align: left;
        }
        .popup h3 { margin-bottom: 15px; text-align: center; }
        .popup input, .popup textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            margin-bottom: 15px;
        }
        .popup-buttons { text-align: right; }
        .popup-buttons button {
            padding: 10px 20px;
            font-size: 1rem;
            min-width: auto;
            margin: 0 4px;
        }
    </style>
</head>
<body>
    <div id="game">
        <h1>âš¡ ååº”åŠ›å¤§æŒ‘æˆ˜</h1>
        <p>å˜ç»¿å°±ç‚¹!</p>
        <div class="name-display" id="nameDisplay"></div>
        
        <button id="btnStart" ontouchstart="btnStartClick(event)">å¼€å§‹æ¸¸æˆ</button>
        <br>
        <button id="btnRank" class="secondary" ontouchstart="btnRankClick(event)">ğŸ† æ’è¡Œæ¦œ</button>
        <button id="btnIdea" class="secondary" ontouchstart="btnIdeaClick(event)">ğŸ’¡ æå»ºè®®</button>
        
        <div class="stats" id="statsDisplay"></div>
        <div id="extraArea"></div>
    </div>

    <script>
        // ===== éŸ³æ•ˆç³»ç»Ÿ =====
        var audioCtx = null;
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        function playBeep(freq, duration, type) {
            if (!audioCtx) return;
            var osc = audioCtx.createOscillator();
            var gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            osc.type = type || 'sine';
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.start(audioCtx.currentTime);
            osc.stop(audioCtx.currentTime + duration);
        }
        
        function playSound(type) {
            initAudio();
            switch(type) {
                case 'wait': playBeep(300, 0.2, 'sine'); break;
                case 'go': playBeep(600, 0.15, 'sine'); playBeep(800, 0.15, 'sine'); break;
                case 'success': playBeep(523, 0.1, 'sine'); playBeep(659, 0.1, 'sine'); playBeep(784, 0.2, 'sine'); break;
                case 'early': playBeep(200, 0.3, 'sawtooth'); break;
                case 'newbest': playBeep(523, 0.1, 'sine'); playBeep(659, 0.1, 'sine'); playBeep(784, 0.1, 'sine'); playBeep(1047, 0.3, 'sine'); break;
            }
        }
        
        // ===== æ¸¸æˆçŠ¶æ€ =====
        var extraArea = document.getElementById('extraArea');
        var nameDisplay = document.getElementById('nameDisplay');
        var statsDisplay = document.getElementById('statsDisplay');
        var state = 'idle';
        var startTime = 0;
        var timer = null;
        var playerName = localStorage.getItem('playerName') || '';
        
        // æœ¬åœ°ç»Ÿè®¡
        var stats = JSON.parse(localStorage.getItem('gameStats') || '{"games":0,"totalTime":0,"best":null}');
        
        // JSONBin.io é…ç½®
        var JSONBIN = {
            binId: '6991c7ba43b1c97be980ddd9',
            accessKey: '$2a$10$RpREaAXDoHiivNJeYo7RxeM5/xZI3RAZJ6VhwfIT40F6ESAr0twuy',
            getApi: function() { return 'https://api.jsonbin.io/v3/b/' + this.binId + '/latest'; },
            updateApi: function() { return 'https://api.jsonbin.io/v3/b/' + this.binId; }
        };
        var API = JSONBIN.getApi(); // å…¼å®¹æ—§ä»£ç 
        
        // ===== åˆå§‹åŒ– =====
        updateNameDisplay();
        updateStatsDisplay();
        
        function updateNameDisplay() {
            if (playerName) {
                var bestBadge = stats.best ? '<span class="best-badge">ğŸ… ' + stats.best + 'ms</span>' : '';
                nameDisplay.innerHTML = 'å½“å‰: ' + playerName + bestBadge + ' <button class="small secondary" ontouchstart="changeNameClick(event)">æ”¹å</button>';
            } else {
                nameDisplay.innerHTML = '';
            }
        }
        
        function updateStatsDisplay() {
            if (stats.games > 0) {
                var avg = Math.round(stats.totalTime / stats.games);
                statsDisplay.innerHTML = 'å±€æ•°: ' + stats.games + ' | å¹³å‡: ' + avg + 'ms' + (stats.best ? ' | æœ€ä½³: ' + stats.best + 'ms' : '');
            } else {
                statsDisplay.innerHTML = '';
            }
        }
        
        function saveStats() {
            localStorage.setItem('gameStats', JSON.stringify(stats));
            updateStatsDisplay();
            updateNameDisplay();
        }
        
        // ===== è¯„ä»·ç³»ç»Ÿ =====
        function getRating(ms) {
            if (ms < 200) return { text: 'âš¡ ç¥é€Ÿ!', class: 'rating' };
            if (ms < 250) return { text: 'ğŸ”¥ è¶…å¿«!', class: 'rating' };
            if (ms < 300) return { text: 'ğŸ‘ å¾ˆå¿«!', class: 'rating' };
            if (ms < 400) return { text: 'ğŸ˜Š æ­£å¸¸', class: 'rating' };
            if (ms < 500) return { text: 'ğŸ¢ æœ‰ç‚¹æ…¢', class: 'rating' };
            return { text: 'ğŸ’¤ å¤ªæ…¢äº†', class: 'rating' };
        }
        
        // ===== æŒ‰é’®å¤„ç† =====
        function btnStartClick(e) {
            e.preventDefault();
            e.stopPropagation();
            startGame();
        }
        
        function btnRankClick(e) {
            e.preventDefault();
            e.stopPropagation();
            showRank();
        }
        
        function btnIdeaClick(e) {
            e.preventDefault();
            e.stopPropagation();
            showIdeas();
        }
        
        function changeNameClick(e) {
            e.preventDefault();
            e.stopPropagation();
            showNamePopup();
        }
        
        document.getElementById('btnStart').onclick = btnStartClick;
        document.getElementById('btnRank').onclick = btnRankClick;
        document.getElementById('btnIdea').onclick = btnIdeaClick;
        
        // ===== å¼¹çª—ç³»ç»Ÿ =====
        function showPopup(html) {
            extraArea.innerHTML = '<div class="popup-overlay" ontouchstart="closePopup(event)">' + html + '</div>';
        }
        
        function closePopup(e) {
            if (e.target.classList.contains('popup-overlay')) {
                extraArea.innerHTML = '';
            }
        }
        
        function showNamePopup() {
            var html = '<div class="popup">' +
                '<h3>ä¿®æ”¹åå­—</h3>' +
                '<input id="playerNameInput" value="' + playerName + '" placeholder="è¾“å…¥æ–°åå­—" />' +
                '<div class="popup-buttons">' +
                '<button class="secondary" onclick="extraArea.innerHTML=\'\'">å–æ¶ˆ</button>' +
                '<button onclick="confirmNameChange()">ç¡®å®š</button>' +
                '</div></div>';
            showPopup(html);
        }
        
        function confirmNameChange() {
            var input = document.getElementById('playerNameInput');
            if (input && input.value.trim()) {
                playerName = input.value.trim();
                localStorage.setItem('playerName', playerName);
                updateNameDisplay();
            }
            extraArea.innerHTML = '';
        }
        
        function showIdeas() {
            var html = '<div class="popup">' +
                '<h3>ğŸ’¡ æ”¹è¿›å»ºè®®</h3>' +
                '<textarea id="ideaText" placeholder="å†™ä¸‹ä½ çš„å»ºè®®..."></textarea>' +
                '<div class="popup-buttons">' +
                '<button class="secondary" onclick="extraArea.innerHTML=\'\'">å–æ¶ˆ</button>' +
                '<button onclick="submitIdea()">æäº¤</button>' +
                '</div></div>';
            showPopup(html);
        }
        
        // JSONBin æ•°æ®æ“ä½œ
        var jsonbinCache = { rank: [], ideas: [] };
        
        function loadJsonBinData() {
            return fetch(JSONBIN.getApi(), {
                headers: {
                    'X-Bin-Meta': 'false',
                    'X-Access-Key': JSONBIN.accessKey
                }
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data && data.record) {
                    jsonbinCache = data.record;
                }
                return jsonbinCache;
            })
            .catch(function() {
                return jsonbinCache;
            });
        }
        
        function saveJsonBinData(data) {
            return fetch(JSONBIN.updateApi(), {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Access-Key': JSONBIN.accessKey
                },
                body: JSON.stringify(data)
            });
        }
        
        function submitIdea() {
            var idea = document.getElementById('ideaText').value;
            if (idea && idea.trim()) {
                // å…ˆåŠ è½½æ•°æ®
                loadJsonBinData().then(function(data) {
                    data.ideas = data.ideas || [];
                    data.ideas.push({idea: idea.trim(), time: Date.now()});
                    
                    // ä¿å­˜å¹¶æäº¤
                    saveJsonBinData(data).then(function() {
                        alert('æ„Ÿè°¢å»ºè®®! ğŸ‰');
                        extraArea.innerHTML = '';
                    }).catch(function() {
                        alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                    });
                });
            }
        }
        
        function showRank() {
            extraArea.innerHTML = '<div class="popup-overlay" onclick="extraArea.innerHTML=\'\'"><div class="popup" style="max-height:70vh;overflow-y:auto;"><h3>ğŸ† æ’è¡Œæ¦œ</h3><div id="rankList">åŠ è½½ä¸­...</div></div></div>';
            
            // ä» JSONBin åŠ è½½
            loadJsonBinData().then(function(data) {
                var list = document.getElementById('rankList');
                var rankData = data.rank || [];
                if (!rankData || rankData.length === 0) {
                    list.innerHTML = '<p style="text-align:center;">æš‚æ— è®°å½•</p>';
                } else {
                    var html = '<div class="rank-box">';
                    for (var i = 0; i < Math.min(rankData.length, 10); i++) {
                        var cls = '';
                        if (i === 0) cls = 'first';
                        else if (i === 1) cls = 'second';
                        else if (i === 2) cls = 'third';
                        html += '<div class="rank-item ' + cls + '"><span>' + (i+1) + '. ' + rankData[i].name + '</span><span>' + rankData[i].ms + ' ms</span></div>';
                    }
                    html += '</div>';
                    list.innerHTML = html;
                }
            }).catch(function() {
                document.getElementById('rankList').innerHTML = '<p style="text-align:center;">åŠ è½½å¤±è´¥</p>';
            });
        }
        
        // ===== æ¸¸æˆé€»è¾‘ =====
        function startGame() {
            if (!playerName) {
                showNamePopupStartGame();
                return;
            }
            
            state = 'waiting';
            document.getElementById('game').className = 'waiting';
            document.getElementById('game').innerHTML = '<h1>â³ ç­‰å¾…...</h1><p>çœ‹åˆ°ç»¿è‰²ç«‹åˆ»ç‚¹!</p>';
            playSound('wait');
            
            var delay = 1500 + Math.random() * 2500;
            timer = setTimeout(go, delay);
        }
        
        function showNamePopupStartGame() {
            var html = '<div class="popup">' +
                '<h3>è¯·è¾“å…¥ä½ çš„åå­—</h3>' +
                '<input id="playerNameInput" placeholder="åå­—" />' +
                '<div class="popup-buttons">' +
                '<button class="secondary" onclick="cancelName()">åŒ¿å</button>' +
                '<button onclick="confirmName()">ç¡®å®š</button>' +
                '</div></div>';
            showPopup(html);
        }
        
        function confirmName() {
            var input = document.getElementById('playerNameInput');
            if (input && input.value.trim()) {
                playerName = input.value.trim();
                localStorage.setItem('playerName', playerName);
            } else {
                playerName = 'åŒ¿å';
            }
            extraArea.innerHTML = '';
            updateNameDisplay();
            startGame();
        }
        
        function cancelName() {
            playerName = 'åŒ¿å';
            extraArea.innerHTML = '';
            startGame();
        }
        
        function go() {
            state = 'go';
            document.getElementById('game').className = 'go';
            startTime = Date.now();
            document.getElementById('game').innerHTML = '<h1>ğŸ”¥ ç‚¹!</h1><div class="time" id="t">0</div>';
            playSound('go');
            showTime();
        }
        
        function showTime() {
            if (state === 'go') {
                var t = document.getElementById('t');
                if (t) t.textContent = (Date.now() - startTime);
                requestAnimationFrame(showTime);
            }
        }
        
        function gameOver() {
            var ms = Date.now() - startTime;
            state = 'result';
            
            // æ›´æ–°æœ¬åœ°ç»Ÿè®¡
            stats.games++;
            stats.totalTime += ms;
            var isNewBest = false;
            if (!stats.best || ms < stats.best) {
                stats.best = ms;
                isNewBest = true;
            }
            saveStats();
            
            var rating = getRating(ms);
            var bestText = isNewBest ? '<p style="color:#ffd700;font-size:1.2rem;">ğŸ‰ æ–°çºªå½•!</p>' : '';
            
            document.getElementById('game').className = 'result';
            document.getElementById('game').innerHTML = '<h1 class="' + rating.class + '">' + ms + ' ms</h1>' +
                '<div class="' + rating.class + '">' + rating.text + '</div>' + bestText +
                '<p>å†æ¥?</p><button id="btnRetry" ontouchstart="retryClick(event)">å†ç©</button><br>' +
                '<button class="secondary" ontouchstart="backToMenu(event)">è¿”å›èœå•</button>';
            
            // æ’­æ”¾éŸ³æ•ˆ
            if (isNewBest) {
                playSound('newbest');
            } else {
                playSound('success');
            }
            
            // æäº¤æˆç»©åˆ° JSONBin
            loadJsonBinData().then(function(data) {
                data.rank = data.rank || [];
                data.rank.push({name: playerName, ms: ms, time: Date.now()});
                // æ’åºå¹¶åªä¿ç•™å‰10å
                data.rank.sort(function(a, b) { return a.ms - b.ms; });
                data.rank = data.rank.slice(0, 10);
                saveJsonBinData(data);
            });
        }
        
        function retryClick(e) {
            e.preventDefault();
            startGame();
        }
        
        function backToMenu(e) {
            e.preventDefault();
            state = 'idle';
            document.getElementById('game').className = '';
            document.getElementById('game').innerHTML = '<h1>âš¡ ååº”åŠ›å¤§æŒ‘æˆ˜</h1><p>å˜ç»¿å°±ç‚¹!</p><div class="name-display" id="nameDisplay"></div>' +
                '<button id="btnStart" ontouchstart="btnStartClick(event)">å¼€å§‹æ¸¸æˆ</button><br>' +
                '<button id="btnRank" class="secondary" ontouchstart="btnRankClick(event)">ğŸ† æ’è¡Œæ¦œ</button>' +
                '<button id="btnIdea" class="secondary" ontouchstart="btnIdeaClick(event)">ğŸ’¡ æå»ºè®®</button>' +
                '<div class="stats" id="statsDisplay"></div><div id="extraArea"></div>';
            
            extraArea = document.getElementById('extraArea');
            nameDisplay = document.getElementById('nameDisplay');
            statsDisplay = document.getElementById('statsDisplay');
            
            document.getElementById('btnStart').onclick = btnStartClick;
            document.getElementById('btnRank').onclick = btnRankClick;
            document.getElementById('btnIdea').onclick = btnIdeaClick;
            
            updateNameDisplay();
            updateStatsDisplay();
        }
        
        // ===== æ¸¸æˆåŒºåŸŸç‚¹å‡» =====
        document.getElementById('game').addEventListener('click', function(e) {
            if (state === 'waiting') {
                clearTimeout(timer);
                playSound('early');
                document.getElementById('game').className = 'result too-early';
                document.getElementById('game').innerHTML = '<h1 class="shake">ğŸ˜± å¤ªæ—©äº†!</h1><button id="btnRetry" ontouchstart="retryClick(event)">å†è¯•</button>';
            } else if (state === 'go') {
                gameOver();
            }
        });
    </script>
</body>
</html>
